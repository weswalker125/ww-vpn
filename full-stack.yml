Parameters:
  KeyName:
    Description: Keypair for SSH access to instance.
    Type: AWS::EC2::KeyPair::KeyName
    Default: ww-vpn
  ConfigBucket:
    Description: S3 bucket where the configuration files are located.
    Type: String
    Default: silly.apps.storage
  EniId:
    Description: Network interface ID to use.
    Type: String
    Default: eni-375718a4

Resources:
  VpnSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: OpenVPN connections only.
      SecurityGroupIngress:
      - IpProtocol: udp
        FromPort: '1194'
        ToPort: '1194'
        CidrIp: 0.0.0.0/0
  VpnInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: '/'
      Roles:
      - !Ref VpnRole
  VpnConfigS3Policy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: VpnConfigS3Policy
      PolicyDocument:
        Statement:
        - Effect: Allow
          Action:
          - s3:GetObject*
          - s3:List*
          - s3:PutObject
          Resource: !Sub 'arn:aws:s3:::${ConfigBucket}/ww-vpn/*'
        - Effect: Allow
          Action:
          - ec2:AttachNetworkInterface
          - ec2:DescribeNetworkInterfaces
          - ec2:DetachNetworkInterface
          Resource: '*'
        - Effect: Allow
          Action:
          - ecr:GetDownloadUrlForLayer
          - ecr:BatchGetImage
          - ecr:DescribeImages
          - ecr:GetAuthorizationToken
          - ecr:DescribeRepositories
          - ecr:ListImages
          - ecr:BatchCheckLayerAvailability
          - ecr:GetRepositoryPolicy
          Resource: '*'
      Roles: 
      - !Ref VpnRole
  VpnRole:
    Type: AWS::IAM::Role
    Properties:
      Path: "/"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
            - ec2.amazonaws.com
          Action:
          - sts:AssumeRole 
  Machine:
    Type: AWS::EC2::Instance
    Properties:
      SecurityGroups:
      - !Ref VpnSecurityGroup
      - 'SSH Access'
      KeyName: !Ref KeyName
      IamInstanceProfile: !Ref VpnInstanceProfile
      ImageId: ami-55ef662f # Amazon Linux 2017.09.1
      InstanceType: t2.micro
      UserData: 
        'Fn::Base64': !Sub
          - |
            #!/bin/bash
            yum -y update 
            yum -y install ec2-net-utils docker jq
            aws configure set region ${Region}
            service docker start
            mkdir /tmp/clients
            
            # Attach ENI
            instance_id=$(wget -q -O - http://169.254.169.254/latest/meta-data/instance-id)
            attachment_id=$(aws ec2 describe-network-interfaces --network-interface-ids ${EniId} | jq -r '.NetworkInterfaces[0].Attachment.AttachmentId')
            aws ec2 detach-network-interface --attachment-id $attachment_id --force
            until aws ec2 attach-network-interface --device-index 1 --instance-id $instance_id --network-interface-id ${EniId}; do
              sleep 5
            done
            ec2ifup eth1

            # Firewall rules
            iptables -F FORWARD
            iptables -F INPUT
            iptables -F OUTPUT
            iptables -X
            iptables -P INPUT DROP
            iptables -P OUTPUT DROP
            iptables -P FORWARD DROP
            iptables -A INPUT -i lo -j ACCEPT
            iptables -A OUTPUT -o lo -j ACCEPT
            iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
            iptables -A INPUT -p tcp --dport 22 -m state --state NEW -s 0.0.0.0/0 -j ACCEPT
            iptables -A INPUT -p udp --dport 1194 -m state --state NEW -s 0.0.0.0/0 -j ACCEPT
            iptables -I OUTPUT 1 -m state --state RELATED,ESTABLISHED -j ACCEPT
            iptables -A OUTPUT -p udp --dport 53 -m state --state NEW -j ACCEPT
            iptables -A OUTPUT -p tcp --dport 53 -m state --state NEW -j ACCEPT
            iptables -A OUTPUT -p tcp --dport 80 -m state --state NEW -j ACCEPT
            iptables -A OUTPUT -p tcp --dport 443 -m state --state NEW -j ACCEPT
            iptables -t nat -A POSTROUTING -s 172.16.100.0/24 -o eth0 -j MASQUERADE
            iptables -A INPUT -i tun0 -j ACCEPT
            iptables -A FORWARD -i tun0 -j ACCEPT
            iptables -A OUTPUT -o tun0 -j ACCEPT
            iptables -A FORWARD -i tun0 -o eth0 -m state --state RELATED,ESTABLISHED -j ACCEPT
            iptables -A FORWARD -i eth0 -o tun+ -m state --state RELATED,ESTABLISHED -j ACCEPT
            iptables -A FORWARD -i tun0 -s 172.16.100.0/24 -d 0.0.0.0/0 -j ACCEPT
            iptables -A FORWARD -i tun0 -s 172.16.100.0/24 -d 172.16.100.0/24 -j DROP

            # Log in to Docker Registry
            $(aws ecr get-login --no-include-email --region ${Region})
            
            # Run container
            docker run -d -p 1194:1194/udp --device=/dev/net/tun --cap-add=NET_ADMIN -v /tmp/clients:/clients 686155034699.dkr.ecr.us-east-1.amazonaws.com/ww-vpn:latest
            
            # Upload generated OVPN Configs to S3.
            until [ -e /tmp/clients/ww-vpn-5.conf ]; do echo "VPN configs not yet available..."; sleep 5; done
            for i in {1..5}; do aws s3 cp /tmp/clients/ww-vpn-$i.conf s3://${ConfigBucket}/ww-vpn/${StackName}/; done
          - { EniId: !Ref EniId, Region: !Ref 'AWS::Region', StackName: !Ref 'AWS::StackName' }